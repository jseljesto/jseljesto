<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="stylesheet.css" />
    <meta charset="UTF-8">
</head>

<body>
    <canvas id="solarCanvas" width="550" height="550"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.3/fabric.min.js"></script>
    <script type="module">
        import {gradients} from "./planetGradients.js";

        console.log(gradients.length);
        let canvas = new fabric.StaticCanvas("solarCanvas");
        canvas.setWidth(screen.width - 25);
        canvas.setHeight(screen.height - 125);
        let ctx = canvas.getContext();

        let shadow = new fabric.Shadow({
            color: "white", blur: 10
        });
        //Maote Ã¥ leggja til pattern, kan bli viktig!!

        /*fabric.util.loadImage('./patterns/pattern.png', function (img) {
            planet.setPatternFill({
                source: img,
                repeat: 'repeat'
            });
            canvas.renderAll();
        }); */

        let stars = [];
        let planets = [];

        //Create planets
        for (let a = 0; a < 3; a++) {
            let foundAvailableSpace = false;
            planetOuterloop:
            while (foundAvailableSpace === false) {
                let y = Math.floor(Math.random() * (screen.height - 225)) + 1;
                let x = Math.floor(Math.random() * (screen.width - 125)) + 1;
                if (planets != undefined || planets.length > 0) {
                    for (let j = 0; j < planets.length; j++) {
                        if ((x < planets[j].left - 150 || x > planets[j].left + 150)
                            && (y < planets[j].top + 150 || y > planets[j].top - 150)) {
                        } else {
                         /*   console.log(j + ": Found similarities: " + x + " " + y + " = "
                                + planets[j].left + " " + planets[j].top); */
                                a--;
                            break planetOuterloop;
                        }
                    }
                }
                let newPlanet = new fabric.Circle({
                    radius: 50, fill: "blue", left: x, top: y, shadow: shadow
                });
                let blurRadius = Math.floor(Math.random() * 10) + 1;
                newPlanet.shadow.blur = blurRadius;
                console.log("X: " + x + " Y: " + y);
                let chosenColor = Math.floor(Math.random() * gradients.length-1) + 1;
                newPlanet.setGradient("fill", {
                    x1: 0,
                    y1: 0,
                    x2: 0,
                    y2: newPlanet.height,
                    colorStops: {
                        0: gradients[chosenColor].firstColor,
                        0.25: gradients[chosenColor].secondColor,
                        0.5: gradients[chosenColor].thirdColor,
                        0.75: gradients[chosenColor].fourthColor,
                        1: gradients[chosenColor].fifthColor
                    }
                });
                planets.push(newPlanet);
                canvas.add(newPlanet);
                foundAvailableSpace = true;
            }
        }

        //Create stars
        for (let i = 0; i < 50; i++) {
            let foundAvailableSpace = false;
            outerloop:
            while (foundAvailableSpace == false) {
                let y = Math.floor(Math.random() * (screen.height - 125)) + 1;
                let x = Math.floor(Math.random() * (screen.width - 25)) + 1;
                if (stars != undefined || stars.length > 0) {
                    for (let j = 0; j < stars.length; j++) {
                        if ((x < stars[j].left - 5 || x > stars[j].left + 5)
                            && (y < stars[j].top + 5 || y > stars[j].top - 5)) {
                        } else {
                         /*   console.log(i + ": Found similarities: " + x + " " + y + " = "
                                + stars[j].left + " " + stars[j].top); */
                            i--;
                            break outerloop;
                        }
                    }
                }
                for (let p = 0; p < planets.length; p++) {
                    if ((x < planets[p].left - 10 || x > planets[p].left + 100)
                        && (y < planets[p].top + 10 || y > planets[p].top - 10)) {
                    } else {
                     /*   console.log(i + ": Found similarities with planet: " + x + " " + y + " = "
                            + planets[p].left + " " + planets[p].top); */
                        i--;
                        break outerloop;
                    }
                }
                let newStar = new fabric.Circle({
                    radius: 4, fill: "white", left: x, top: y, shadow: shadow
                });
                stars.push(newStar);
                canvas.add(newStar);
                foundAvailableSpace = true;
            }
        }

        let angle = 0;
        setInterval(rotatePlanet, 100);
        setInterval(blinkStars, 100);

        function rotatePlanet() {
            canvas.clear();
            angle = angle + 2;
            for (let i = 0; i < planets.length; i++) {
                planets[i].rotate(angle);
                canvas.add(planets[i]);
            }
        }

        function blinkStars () {
            for (let i = 0; i < stars.length; i++) {
                if(stars[i].shadow.blur == 1) {
                    stars[i].shadow.blur++;
                }
                else if (stars[i].shadow.blur == 10) {
                    stars[i].shadow.blur--;
                }
                else {
                    let roll = Math.floor(Math.random() * 10) + 1;
                    if (roll <= 5) {
                        stars[i].shadow.blur++;
                    }
                    else if (roll > 5) {
                        stars[i].shadow.blur--;
                    }
                }
                canvas.add(stars[i]);
            }
        }

    </script>
</body>
</html>